name: Manual Test & Debug

on:
  workflow_dispatch:
    inputs:
      test_mode:
        description: 'æµ‹è¯•æ¨¡å¼'
        required: true
        default: 'quick'
        type: choice
        options:
        - quick
        - full
        - debug
      target_category:
        description: 'æŒ‡å®šæµ‹è¯•çš„åˆ†ç±» (å¯é€‰)'
        required: false
        default: ''
      max_articles:
        description: 'æœ€å¤§æ–‡ç« æ•° (æµ‹è¯•ç”¨)'
        required: false
        default: '10'

jobs:
  test-update:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install feedparser requests python-dateutil lxml
    
    - name: Environment Debug
      run: |
        echo "=== å®Œæ•´çŽ¯å¢ƒä¿¡æ¯ ==="
        echo "æ“ä½œç³»ç»Ÿ: $(uname -a)"
        echo "Pythonç‰ˆæœ¬: $(python --version)"
        echo "å·¥ä½œç›®å½•: $(pwd)"
        echo "ç”¨æˆ·: $(whoami)"
        echo ""
        echo "=== ç›®å½•ç»“æž„ ==="
        find . -type f -name "*.py" | head -10
        echo ""
        echo "=== å¿…è¦æ–‡ä»¶æ£€æŸ¥ ==="
        for file in "ç”Ÿæˆç´¯ç§¯æ–°é—».py" "ç”Ÿæˆç´¯ç§¯RSS.py" "daily_update.py" "src/rss_read.py" "src/load_rss_url.py" "RSS feed URL/rss_feed_url.json"; do
          if [ -f "$file" ]; then
            echo "âœ… $file ($(stat -c%s "$file" 2>/dev/null || stat -f%z "$file" 2>/dev/null) bytes)"
          else
            echo "âŒ $file ä¸å­˜åœ¨"
          fi
        done
        echo ""
        echo "=== RSSé…ç½®å†…å®¹é¢„è§ˆ ==="
        if [ -f "RSS feed URL/rss_feed_url.json" ]; then
          echo "å‰10è¡Œå†…å®¹:"
          head -10 "RSS feed URL/rss_feed_url.json"
        fi
    
    - name: Quick Test
      if: github.event.inputs.test_mode == 'quick'
      run: |
        echo "=== å¿«é€Ÿæµ‹è¯•æ¨¡å¼ ==="
        python -c "
        import sys
        sys.path.append('src')
        try:
            from load_rss_url import load_rss_sources
            from rss_read import read_rss_feed
            print('âœ… æ¨¡å—å¯¼å…¥æˆåŠŸ')
            
            # æµ‹è¯•åŠ è½½RSSé…ç½®
            sources = load_rss_sources('RSS feed URL/rss_feed_url.json')
            print(f'âœ… åŠ è½½äº† {len(sources)} ä¸ªRSSæº')
            
            # æµ‹è¯•è¯»å–ä¸€ä¸ªRSSæº
            if sources:
                test_url = sources[0].get('rss')
                if test_url:
                    entries = read_rss_feed(test_url)
                    print(f'âœ… æµ‹è¯•RSSè¯»å–æˆåŠŸï¼ŒèŽ·å¾— {len(entries) if entries else 0} ç¯‡æ–‡ç« ')
                else:
                    print('âŒ æ²¡æœ‰æ‰¾åˆ°æµ‹è¯•RSS URL')
            
        except Exception as e:
            print(f'âŒ æµ‹è¯•å¤±è´¥: {e}')
            import traceback
            traceback.print_exc()
            sys.exit(1)
        "
    
    - name: Full Test
      if: github.event.inputs.test_mode == 'full'
      run: |
        echo "=== å®Œæ•´æµ‹è¯•æ¨¡å¼ ==="
        # ä¿®æ”¹é…ç½®ä»¥å‡å°‘æ–‡ç« æ•°é‡
        python -c "
        import sys
        # ä¸´æ—¶ä¿®æ”¹æœ€å¤§æ–‡ç« æ•°
        with open('ç”Ÿæˆç´¯ç§¯æ–°é—».py', 'r', encoding='utf-8') as f:
            content = f.read()
        content = content.replace('max_articles_per_source = 100000', 'max_articles_per_source = ${{ github.event.inputs.max_articles }}')
        with open('ç”Ÿæˆç´¯ç§¯æ–°é—».py', 'w', encoding='utf-8') as f:
            f.write(content)
        print('âœ… å·²ä¿®æ”¹æµ‹è¯•é…ç½®')
        "
        
        # è¿è¡Œå®Œæ•´æµç¨‹
        python daily_update.py
    
    - name: Debug Mode
      if: github.event.inputs.test_mode == 'debug'
      run: |
        echo "=== è°ƒè¯•æ¨¡å¼ ==="
        
        # åˆ›å»ºè°ƒè¯•ç‰ˆæœ¬çš„è„šæœ¬
        cat > debug_test.py << 'EOF'
        import sys
        import os
        import traceback
        
        print("=== è°ƒè¯•å¼€å§‹ ===")
        
        try:
            # æ£€æŸ¥å·¥ä½œç›®å½•
            print(f"å½“å‰ç›®å½•: {os.getcwd()}")
            print(f"ç›®å½•å†…å®¹: {os.listdir('.')}")
            
            # æ£€æŸ¥srcç›®å½•
            if os.path.exists('src'):
                print(f"srcç›®å½•å†…å®¹: {os.listdir('src')}")
            
            # å°è¯•å¯¼å…¥æ¨¡å—
            sys.path.append('src')
            print("å¼€å§‹å¯¼å…¥æ¨¡å—...")
            
            from load_rss_url import load_rss_sources
            print("âœ… load_rss_url å¯¼å…¥æˆåŠŸ")
            
            from rss_read import read_rss_feed, generate_historical_news_by_categories
            print("âœ… rss_read å¯¼å…¥æˆåŠŸ")
            
            # æµ‹è¯•é…ç½®åŠ è½½
            config_file = 'RSS feed URL/rss_feed_url.json'
            if os.path.exists(config_file):
                sources = load_rss_sources(config_file)
                print(f"âœ… æˆåŠŸåŠ è½½ {len(sources)} ä¸ªRSSæº")
                
                # æ˜¾ç¤ºå‰3ä¸ªæºçš„ä¿¡æ¯
                for i, source in enumerate(sources[:3]):
                    print(f"æº {i+1}: {source.get('name', 'Unknown')} - {source.get('category', 'No category')}")
            else:
                print(f"âŒ é…ç½®æ–‡ä»¶ä¸å­˜åœ¨: {config_file}")
            
        except Exception as e:
            print(f"âŒ è°ƒè¯•è¿‡ç¨‹ä¸­å‡ºé”™: {e}")
            traceback.print_exc()
            sys.exit(1)
        
        print("=== è°ƒè¯•ç»“æŸ ===")
        EOF
        
        python debug_test.py
    
    - name: Upload debug artifacts
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: test-results-${{ github.event.inputs.test_mode }}-${{ github.run_number }}
        path: |
          *.log
          cumulative_news/
          feed/
        retention-days: 7
    
    - name: Test Summary
      if: always()
      run: |
        echo "## ðŸ§ª æµ‹è¯•ç»“æžœ" >> $GITHUB_STEP_SUMMARY
        echo "- **æµ‹è¯•æ¨¡å¼**: ${{ github.event.inputs.test_mode }}" >> $GITHUB_STEP_SUMMARY
        echo "- **çŠ¶æ€**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
        echo "- **æ—¶é—´**: $(date)" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ github.event.inputs.target_category }}" != "" ]; then
          echo "- **ç›®æ ‡åˆ†ç±»**: ${{ github.event.inputs.target_category }}" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ -d "feed" ]; then
          echo "- **ç”Ÿæˆçš„RSSæ–‡ä»¶**:" >> $GITHUB_STEP_SUMMARY
          ls -la feed/ >> $GITHUB_STEP_SUMMARY
        fi