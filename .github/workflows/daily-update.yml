name: Daily News Update

on:
  schedule:
    - cron: '0 23,5,8 * * *'  # åŒ—äº¬æ—¶é—´ 7, 13, 16 ç‚¹è§¦å‘
  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      max_articles:
        description: 'æ¯ä¸ªæºæœ€å¤šèŽ·å–çš„æ–‡ç« æ•°é‡'
        required: false
        default: '100000'
      debug_mode:
        description: 'å¯ç”¨è°ƒè¯•æ¨¡å¼'
        required: false
        default: false
        type: boolean

permissions:
  contents: write
  pages: write
  id-token: write

# æ·»åŠ å¹¶å‘æŽ§åˆ¶
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  update-news:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
    
    - name: Cache pip dependencies
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
        pip install feedparser requests python-dateutil lxml
    
    - name: Configure Git
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
    
    - name: Debug environment (if enabled)
      if: ${{ github.event.inputs.debug_mode == 'true' }}
      run: |
        echo "=== è°ƒè¯•ä¿¡æ¯ ==="
        echo "å·¥ä½œç›®å½•: $(pwd)"
        echo "ç›®å½•ç»“æž„:"
        ls -la
        echo "æ ¸å¿ƒç›®å½•:"
        ls -d news_agent/ scripts/ config/ data/ outputs/ 2>/dev/null || echo "éƒ¨åˆ†ç›®å½•ä¸å­˜åœ¨"
        echo "Pythonç‰ˆæœ¬: $(python --version)"
        echo "å½“å‰æ—¶é—´:"
        echo "UTCæ—¶é—´: $(date -u '+%Y-%m-%d %H:%M:%S')"
        echo "åŒ—äº¬æ—¶é—´: $(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')"
        if [ -f "config/rss_feed_urls.json" ]; then
          echo "âœ… RSSé…ç½®æ–‡ä»¶å­˜åœ¨ (config/rss_feed_urls.json)"
        else
          echo "âŒ RSSé…ç½®æ–‡ä»¶ä¸å­˜åœ¨"
        fi
        echo "PythonåŒ…ç»“æž„:"
        ls -la news_agent/ 2>/dev/null || echo "news_agentåŒ…ä¸å­˜åœ¨"
    
    - name: Show trigger info
      run: |
        echo "å½“å‰UTCæ—¶é—´: $(date -u '+%Y-%m-%d %H:%M:%S')"
        echo "å½“å‰åŒ—äº¬æ—¶é—´: $(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')"
        echo "è§¦å‘æ–¹å¼: ${{ github.event_name }}"
        echo "âœ… å¼€å§‹æ‰§è¡Œæ›´æ–°ä»»åŠ¡"
    
    - name: Run update (using new structure)
      env:
        MAX_ARTICLES: ${{ github.event.inputs.max_articles || '100000' }}
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
      run: |
        BEIJING_TIME=$(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')
        echo "=== å¼€å§‹æ–°é—»æ›´æ–° (ä½¿ç”¨æ–°ç»“æž„) ==="
        echo "åŒ—äº¬æ—¶é—´: $BEIJING_TIME"
        echo "æœ€å¤§æ–‡ç« æ•°: $MAX_ARTICLES"
        echo "è§¦å‘æ–¹å¼: ${{ github.event_name }}"
        echo ""
        
        # éªŒè¯æ–°ç»“æž„
        echo "ðŸ“‚ éªŒè¯é¡¹ç›®ç»“æž„..."
        [ -d "news_agent" ] && echo "âœ… news_agent/ åŒ…å­˜åœ¨" || echo "âŒ news_agent/ ä¸å­˜åœ¨"
        [ -d "scripts" ] && echo "âœ… scripts/ ç›®å½•å­˜åœ¨" || echo "âŒ scripts/ ä¸å­˜åœ¨"
        [ -d "config" ] && echo "âœ… config/ ç›®å½•å­˜åœ¨" || echo "âŒ config/ ä¸å­˜åœ¨"
        [ -d "data" ] && echo "âœ… data/ ç›®å½•å­˜åœ¨" || echo "âŒ data/ ä¸å­˜åœ¨"
        [ -d "outputs" ] && echo "âœ… outputs/ ç›®å½•å­˜åœ¨" || echo "âŒ outputs/ ä¸å­˜åœ¨"
        echo ""
        
        # æ­¥éª¤1: ç”Ÿæˆç´¯ç§¯æ–°é—»
        echo "ðŸ“° æ­¥éª¤ 1/2: ç”Ÿæˆç´¯ç§¯æ–°é—»..."
        python scripts/build_cumulative_news.py --max-articles ${MAX_ARTICLES}
        echo ""
        
        # æ­¥éª¤2: ç”ŸæˆRSS Feed
        echo "ðŸ“¡ æ­¥éª¤ 2/2: ç”ŸæˆRSS Feed..."
        python scripts/build_cumulative_feed.py
        echo ""
        
        echo "âœ… æ–°é—»æ›´æ–°å®Œæˆï¼"

    - name: Update index.html stats and timestamp
      run: |
        BEIJING_TIME=$(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')
        echo "ðŸ•’ æ­£åœ¨åŒæ­¥ index.html æ—¶é—´æˆ³: $BEIJING_TIME"
        
        # æ›´æ–°æœ€åŽæ›´æ–°æ—¶é—´
        sed -i "s/[0-9]\{4\}-[0-9]\{2\}-[0-9]\{2\} [0-9]\{2\}:[0-9]\{2\}:[0-9]\{2\} CST/$BEIJING_TIME CST/g" index.html
        
        # (å¯é€‰) è‡ªåŠ¨æ›´æ–°æ€»è®¢é˜…æºæ•°é‡
        RSS_COUNT=$(ls outputs/feed/*.xml 2>/dev/null | wc -l)
        sed -i "s/id=\"totalFeeds\">[0-9]*<\/span>/id=\"totalFeeds\">$RSS_COUNT<\/span>/" index.html
        
        echo "âœ… index.html å·²åŒæ­¥"

    - name: Verify generated files (new structure)
      run: |
        echo "=== æ£€æŸ¥ç”Ÿæˆçš„æ–‡ä»¶ (æ–°ç»“æž„) ==="
        echo ""
        echo "ðŸ“„ æ ¹ç›®å½•æ–‡ä»¶:"
        ls -la *.html 2>/dev/null || echo "æ²¡æœ‰HTMLæ–‡ä»¶"
        echo ""
        
        echo "ðŸ“¡ RSS Feed ç›®å½• (outputs/feed/):"
        if [ -d "outputs/feed" ]; then
          ls -lh outputs/feed/*.xml 2>/dev/null || echo "æ²¡æœ‰XMLæ–‡ä»¶"
          RSS_COUNT=$(ls outputs/feed/*.xml 2>/dev/null | wc -l)
          echo "RSSæ–‡ä»¶æ•°é‡: $RSS_COUNT"
        else
          echo "âŒ outputs/feed/ ç›®å½•ä¸å­˜åœ¨"
        fi
        echo ""
        
        echo "ðŸ“° ç´¯ç§¯æ–°é—»ç›®å½• (outputs/cumulative_news/):"
        if [ -d "outputs/cumulative_news" ]; then
          ls -lh outputs/cumulative_news/*.md 2>/dev/null | head -5 || echo "æ²¡æœ‰Markdownæ–‡ä»¶"
          MD_COUNT=$(ls outputs/cumulative_news/*.md 2>/dev/null | wc -l)
          echo "Markdownæ–‡ä»¶æ•°é‡: $MD_COUNT"
        else
          echo "âŒ outputs/cumulative_news/ ç›®å½•ä¸å­˜åœ¨"
        fi
        echo ""
        
        echo "ðŸ“Š æ•°æ®ç›®å½• (data/):"
        if [ -f "data/rss_history.json" ]; then
          SIZE=$(stat -c%s data/rss_history.json 2>/dev/null || stat -f%z data/rss_history.json 2>/dev/null)
          echo "âœ… rss_history.json å­˜åœ¨ (${SIZE} bytes)"
        else
          echo "âš ï¸  rss_history.json ä¸å­˜åœ¨ (é¦–æ¬¡è¿è¡Œæ­£å¸¸)"
        fi
        echo ""
        
        # éªŒè¯index.htmlæ˜¯å¦å­˜åœ¨ä¸”æœ‰å†…å®¹
        if [ -f "index.html" ]; then
          echo "âœ… index.html å­˜åœ¨"
          SIZE=$(stat -c%s index.html 2>/dev/null || stat -f%z index.html 2>/dev/null)
          echo "   æ–‡ä»¶å¤§å°: ${SIZE} bytes"
        else
          echo "âŒ index.html ä¸å­˜åœ¨"
          exit 1
        fi
        
        echo ""
        echo "âœ… æ–‡ä»¶éªŒè¯å®Œæˆï¼"
    
    - name: Check for changes
      id: verify-changed-files
      run: |
        if [ -n "$(git status --porcelain)" ]; then
          echo "changed=true" >> $GITHUB_OUTPUT
          echo "æ£€æµ‹åˆ°æ–‡ä»¶å˜æ›´"
          git status --porcelain
        else
          echo "changed=false" >> $GITHUB_OUTPUT
          echo "æ²¡æœ‰æ£€æµ‹åˆ°æ–‡ä»¶å˜æ›´"
        fi
    
    - name: Commit and push changes
      if: steps.verify-changed-files.outputs.changed == 'true'
      run: |
        BEIJING_TIME=$(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')
        git add .
        git commit -m "ðŸ¤– è‡ªåŠ¨æ›´æ–°æ–°é—» (åŒ—äº¬æ—¶é—´: $BEIJING_TIME) [è§¦å‘æ–¹å¼: ${{ github.event_name }}]"
        git push
    
    - name: Setup Pages
      uses: actions/configure-pages@v4
    
    - name: Upload artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: '.'
    
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
    
    - name: Create summary
      if: always()
      run: |
        BEIJING_TIME=$(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')
        UTC_TIME=$(date -u '+%Y-%m-%d %H:%M:%S')
        
        echo "## ðŸ“Š å®šæ—¶æ›´æ–°ç»“æžœ" >> $GITHUB_STEP_SUMMARY
        echo "- **åŒ—äº¬æ—¶é—´**: $BEIJING_TIME" >> $GITHUB_STEP_SUMMARY
        echo "- **UTCæ—¶é—´**: $UTC_TIME" >> $GITHUB_STEP_SUMMARY
        echo "- **è§¦å‘æ–¹å¼**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **çŠ¶æ€**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
        echo "- **è®¡åˆ’è¿è¡Œ**: åŒ—äº¬æ—¶é—´ 7:00, 12:00, 16:00 (å¯èƒ½æœ‰å»¶è¿Ÿ)" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ steps.deployment.outputs.page_url }}" != "" ]; then
          echo "- **Pages URL**: ${{ steps.deployment.outputs.page_url }}" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "- **æ‰§è¡ŒçŠ¶æ€**: âœ… å·²æ‰§è¡Œæ›´æ–° (æ–°é¡¹ç›®ç»“æž„)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“‚ ç”Ÿæˆæ–‡ä»¶ç»Ÿè®¡" >> $GITHUB_STEP_SUMMARY
        
        # RSS Feed ç»Ÿè®¡
        if [ -d "outputs/feed" ]; then
          rss_count=$(ls outputs/feed/*.xml 2>/dev/null | wc -l)
          echo "- **RSSæº** (outputs/feed/): $rss_count ä¸ª" >> $GITHUB_STEP_SUMMARY
          for file in outputs/feed/*.xml; do
            if [ -f "$file" ]; then
              size=$(stat -c%s "$file" 2>/dev/null || stat -f%z "$file" 2>/dev/null || echo "unknown")
              size_kb=$((size / 1024))
              echo "  - \`$(basename "$file")\`: ${size_kb}KB" >> $GITHUB_STEP_SUMMARY
            fi
          done
        else
          echo "- **RSSæº**: âš ï¸ outputs/feed/ ç›®å½•ä¸å­˜åœ¨" >> $GITHUB_STEP_SUMMARY
        fi
        
        # ç´¯ç§¯æ–°é—»ç»Ÿè®¡
        if [ -d "outputs/cumulative_news" ]; then
          news_count=$(ls outputs/cumulative_news/*.md 2>/dev/null | wc -l)
          echo "- **ç´¯ç§¯æ–°é—»** (outputs/cumulative_news/): $news_count ä¸ª" >> $GITHUB_STEP_SUMMARY
          latest_news=$(ls -t outputs/cumulative_news/cumulative_summary_*.md 2>/dev/null | head -1)
          if [ -n "$latest_news" ]; then
            echo "  - æœ€æ–°: \`$(basename "$latest_news")\`" >> $GITHUB_STEP_SUMMARY
          fi
        else
          echo "- **ç´¯ç§¯æ–°é—»**: âš ï¸ outputs/cumulative_news/ ç›®å½•ä¸å­˜åœ¨" >> $GITHUB_STEP_SUMMARY
        fi
        
        # åŽ†å²æ•°æ®ç»Ÿè®¡
        if [ -f "data/rss_history.json" ]; then
          history_size=$(stat -c%s data/rss_history.json 2>/dev/null || stat -f%z data/rss_history.json 2>/dev/null || echo "0")
          history_kb=$((history_size / 1024))
          echo "- **åŽ†å²æ•°æ®** (data/rss_history.json): ${history_kb}KB" >> $GITHUB_STEP_SUMMARY
        else
          echo "- **åŽ†å²æ•°æ®**: âš ï¸ data/rss_history.json ä¸å­˜åœ¨" >> $GITHUB_STEP_SUMMARY
        fi
    
    - name: Upload logs on failure
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: error-logs-${{ github.run_number }}
        path: |
          daily_update.log
          *.log
        retention-days: 7